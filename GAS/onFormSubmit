function onFormSubmit(e) {
  const sheetValues = e.values;

  // âœ… Googleãƒ•ã‚©ãƒ¼ãƒ ã®å›ç­”ã®åˆ—é †ã«å¿œã˜ã¦ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’èª¿æ•´ï¼
  const department = sheetValues[2]; // ä¾‹ï¼šCåˆ— = "éƒ¨ç½²"
  const content = sheetValues[3];    // ä¾‹ï¼šDåˆ— = "é€ä¿¡å†…å®¹"

  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const masterSheet = ss.getSheetByName("ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿");
  const data = masterSheet.getDataRange().getValues();

  let messageDepartment = department;
  let targetUserIds = [];

  Logger.log(`ğŸ“¥ ãƒ•ã‚©ãƒ¼ãƒ å…¥åŠ› - éƒ¨ç½²: ${department}, å†…å®¹: ${content}`);
  Logger.log(`ğŸ“„ ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ä»¶æ•°ï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼é™¤ãï¼‰: ${data.length - 1}`);

  if (department === "å…¨ä½“") {
    // å…¨å“¡ï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼é™¤ã2åˆ—ç›®ä»¥é™ï¼‰ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼IDï¼ˆCåˆ—: index 2ï¼‰
    targetUserIds = data.slice(1).map(row => row[2]);
    Logger.log(`ğŸŒ å…¨ä½“é€ä¿¡: ${targetUserIds.length}äºº`);
  } else if (department === "å¹¹éƒ¨") {
    // Håˆ—ï¼ˆindex 7ï¼‰ãŒ TRUE ã®è¡Œã®ã¿
    const filtered = data.slice(1).filter(row => {
      const isExec = row[7] === true || row[7] === "TRUE";
      const userId = row[2];
      Logger.log(`ğŸ” å¹¹éƒ¨ãƒã‚§ãƒƒã‚¯: userId=${userId}, å¹¹éƒ¨=${row[7]}`);
      return isExec;
    });

    targetUserIds = filtered.map(row => row[2]);
    messageDepartment = "æ–‡å®Ÿå¹¹éƒ¨";
    Logger.log(`ğŸ¯ å¹¹éƒ¨é€ä¿¡å¯¾è±¡: ${targetUserIds.length}äºº`);
  } else {
    // Eåˆ—ï¼ˆéƒ¨ç½², index 4ï¼‰ã¨ä¸€è‡´ã™ã‚‹äººã‚’å¯¾è±¡
    const filtered = data.slice(1).filter(row => {
      const dept = row[4];
      const userId = row[2];
      Logger.log(`ğŸ” éƒ¨ç½²ãƒã‚§ãƒƒã‚¯: userId=${userId}, éƒ¨ç½²=${dept}`);
      return dept === department;
    });

    targetUserIds = filtered.map(row => row[2]);
    Logger.log(`ğŸ“Œ éƒ¨ç½²ã€Œ${department}ã€é€ä¿¡å¯¾è±¡: ${targetUserIds.length}äºº`);
  }

  const message = `ã€${messageDepartment}å‘ã‘ã®ãŠçŸ¥ã‚‰ã›ã§ã™ã€‘\n${content}`;

  if (targetUserIds.length === 0) {
    Logger.log("âš ï¸ è©²å½“ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚é€ä¿¡ä¸­æ­¢ã€‚");
    return;
  }

  Logger.log("ğŸ“¤ é€ä¿¡å…ˆ:");
  targetUserIds.forEach(userId => Logger.log(` - ${userId}`));

  // LINEé€ä¿¡
  targetUserIds.forEach(userId => {
    sendLineMessage(userId, message);
  });
}


function sendLineMessage(userId, message) {
  const token = PropertiesService.getScriptProperties().getProperty("LINE_ACCESS_TOKEN");

  if (!token) {
    Logger.log("âŒ ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ãŒæœªè¨­å®šã§ã™");
    return;
  }

  const url = "https://api.line.me/v2/bot/message/push";
  const payload = {
    to: userId,
    messages: [{
      type: "text",
      text: message
    }]
  };

  const options = {
    method: "post",
    contentType: "application/json",
    headers: {
      Authorization: "Bearer " + token
    },
    payload: JSON.stringify(payload),
    muteHttpExceptions: true
  };

  const response = UrlFetchApp.fetch(url, options);
  Logger.log(`ğŸ“¨ [${userId}] ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${response.getResponseCode()}`);
  Logger.log(response.getContentText());
}
